<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="tv-api-base" content="https://cs2team39.cs2410-web01pvm.aston.ac.uk">
    <title>Auth Test - Tech Verse</title>
</head>
<body>
    <h1>Authentication Test</h1>

    <h2>Setup Database</h2>
    <p><strong>For better testing without CORS issues, use: <a href="http://127.0.0.1:8000/test-auth" target="_blank">http://127.0.0.1:8000/test-auth</a></strong></p>
    <p><a href="http://127.0.0.1:8000/reset-db" target="_blank">Reset Database (DANGER - deletes all data)</a></p>
    <p><a href="http://127.0.0.1:8000/create-tables" target="_blank">Create Database Tables</a></p>
    <p><a href="http://127.0.0.1:8000/create-admin" target="_blank">Create Admin User</a></p>

    <h2>Register Test User</h2>
    <button id="register-test">Register Test User (test@example.com / password123)</button>
    <div id="register-result"></div>

    <h2>Login Test</h2>
    <div>
        <input type="email" id="login-email" placeholder="Email" value="test@example.com">
        <input type="password" id="login-password" placeholder="Password" value="password123">
        <button id="login-test">Login</button>
    </div>
    <div id="login-result"></div>

    <h2>Current User</h2>
    <div id="current-user"></div>
    <button id="check-user">Check Current User</button>
    <button id="logout-test">Logout</button>
    <div id="logout-result"></div>

        <script>
            // Use relative URLs if served from same domain, absolute if from file system
            const API_BASE = window.location.protocol === 'file:' ? 'http://127.0.0.1:8000/api' : '/api';

        // Register test user
        document.getElementById('register-test').addEventListener('click', async () => {
            const result = document.getElementById('register-result');
            try {
                const resp = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: 'Test User',
                        email: 'test@example.com',
                        password: 'password123',
                        role: 'customer'
                    })
                });

                const data = await resp.json();
                result.innerHTML = `<pre>Status: ${resp.status}\n${JSON.stringify(data, null, 2)}</pre>`;
            } catch (err) {
                result.textContent = `Error: ${err.message}`;
            }
        });

        // Login test
        document.getElementById('login-test').addEventListener('click', async () => {
            const result = document.getElementById('login-result');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const resp = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await resp.json();
                result.innerHTML = `<pre>Status: ${resp.status}\n${JSON.stringify(data, null, 2)}</pre>`;

                if (resp.ok && data.user) {
                    localStorage.setItem('techverse_auth_user', JSON.stringify(data.user));
                }
            } catch (err) {
                result.textContent = `Error: ${err.message}`;
            }
        });

        // Check current user
        document.getElementById('check-user').addEventListener('click', () => {
            const userDiv = document.getElementById('current-user');
            const user = localStorage.getItem('techverse_auth_user');
            if (user) {
                userDiv.innerHTML = `<pre>${user}</pre>`;
            } else {
                userDiv.textContent = 'No user logged in';
            }
        });

        // Logout test
        document.getElementById('logout-test').addEventListener('click', async () => {
            const result = document.getElementById('logout-result');
            try {
                const resp = await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                localStorage.removeItem('techverse_auth_user');
                result.innerHTML = `<pre>Status: ${resp.status}\nLogged out successfully</pre>`;
                document.getElementById('check-user').click();
            } catch (err) {
                result.textContent = `Error: ${err.message}`;
            }
        });

        // Initial check
        document.getElementById('check-user').click();
    </script>
</body>
</html>
